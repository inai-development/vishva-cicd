<!DOCTYPE html>
<html>
<head>
  <title>INAI Chatbot</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e1e1e, #121212);
      color: #fff;
      margin: 0;
      padding: 0;
    }

    #usernamePrompt {
      position: fixed;
      inset: 0;
      background-color: #000000f2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #usernamePrompt input {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      width: 250px;
      margin-bottom: 15px;
    }

    #usernamePrompt button {
      padding: 10px 20px;
      background-color: #00aaff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    .chat-container {
      max-width: 700px;
      margin: 40px auto;
      background: #1c1c1c;
      border-radius: 20px;
      padding: 20px 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      border: 1px solid #2e2e2e;
      display: none;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 26px;
      letter-spacing: 1px;
      color: #00ffff;
    }

    .input-row {
      margin-bottom: 15px;
    }

    .input-row label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #bbb;
    }

    .input-row select {
      width: 100%;
      padding: 10px 12px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      border-radius: 10px;
      font-size: 14px;
      transition: 0.2s ease;
    }

    .input-row select:focus {
      border-color: #00ccff;
      outline: none;
    }

    #chat-box {
      max-height: 350px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 12px;
      background-color: #222;
      border: 1px solid #333;
    }

    #messages {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #messages li {
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
    }

    #messages .user {
      background: #0055aa;
      color: #fff;
      align-self: flex-end;
      margin-left: auto;
      text-align: right;
    }

    #messages .bot {
      background: #333;
      color: #ffcc00;
      align-self: flex-start;
      margin-right: auto;
      text-align: left;
    }

    #controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 10px 15px;
      border-radius: 12px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      font-size: 14px;
    }

    #sendBtn, #mic-btn {
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    #sendBtn {
      background: #00aaff;
      color: #fff;
    }

    #sendBtn:hover {
      background: #0088cc;
    }

    #mic-btn {
      background: #00cc66;
      color: white;
    }

    #mic-btn:hover {
      background: #009955;
    }

    audio {
      margin-top: 10px;
      width: 100%;
    }

    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      border-radius: 10px;
      overflow-x: auto;
    }

    ul {
      padding-left: 20px;
    }
  </style>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- Username Modal -->
  <div id="usernamePrompt">
    <h2 style="color:#00ffff">Enter Your Name</h2>
    <input type="text" id="usernameInput" placeholder="Your name..." />
    <button onclick="setUsername()">Continue</button>
  </div>

  <!-- Chat UI -->
  <div class="chat-container" id="chatUI">
    <h1>INAI Chatbot</h1>

    <div class="input-row">
      <label for="mode">Mode:</label>
      <select id="mode">
        <option value="friend">Friend</option>
        <option value="info">Info</option>
        <option value="elder">Elder</option>
        <option value="love">Love</option>
      </select>
    </div>

    <div id="chat-box">
      <ul id="messages"></ul>
    </div>

    <div id="controls">
      <input type="text" id="messageInput" placeholder="Type or Speak..." />
      <button id="sendBtn">Send</button>
      <button id="mic-btn">ðŸŽ¤</button>
    </div>

    <audio id="audioPlayer" hidden></audio>
  </div>

  <script>
    let socket;
    let audioQueue = [];
    let isPlaying = false;
    let user_id = "";

    function setUsername() {
      const input = document.getElementById("usernameInput");
      const name = input.value.trim();
      if (!name) {
        alert("Please enter your name");
        return;
      }
      user_id = name.replace(/\s+/g, "_").toLowerCase();
      document.getElementById("usernamePrompt").style.display = "none";
      document.getElementById("chatUI").style.display = "block";
      initializeSocket();
    }

    function initializeSocket() {
      // socket = io("http://13.234.84.236:8000", { transports: ["websocket"] });
      // socket = io("http://192.168.1.89:7200", { transports: ["websocket"] });

      // socket = io("http://192.168.1.89:4210", {
      //   path: "/socket.io",
      //   transports: ["websocket"]
      // });

      socket = io("http://13.234.84.236:8000", {
        path: "/socket.io",
        transports: ["websocket"]
      });

      socket.on("connect", () => {
        console.log("âœ… Connected:", socket.id);
        socket.emit("register_user", { user_id });
      });

      socket.on("disconnect", () => {
        alert("INAI is under maintenance. Please try again later.");
      });

      socket.on("response", (data) => {
        const botLi = displayBotMessage(data.text);
        if (data.audio) playAudio(data.audio);
        if (data.visemes) fetchVisemes(botLi, data.visemes);
      });

      socket.on("streaming_audio", (data) => {
        if (data.audio) {
          audioQueue.push("data:audio/wav;base64," + data.audio);
          if (!isPlaying) playQueue();
        }
      });

      socket.on("mode_change", (data) => {
        document.getElementById("mode").value = data.mode;
      });
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const mode = document.getElementById("mode").value;
      const msg = input.value.trim();
      if (!msg) return;

      const audioPlayer = document.getElementById("audioPlayer");
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      isPlaying = false;
      audioQueue = [];

      displayUserMessage(msg);
      input.value = '';

      socket.emit("user_message", { user_id, mode, text: msg });
    }

    function displayUserMessage(msg) {
      const li = document.createElement("li");
      li.textContent = "You: " + msg;
      li.className = "user";
      document.getElementById("messages").appendChild(li);
      scrollToBottom();
    }

    function displayBotMessage(msg) {
      const li = document.createElement("li");
      li.className = "bot";
      li.innerHTML = "<b>AI:</b><br>" + formatBotMessage(msg);
      document.getElementById("messages").appendChild(li);
      scrollToBottom();
      return li;
    }

    function fetchVisemes(parentLi, url) {
      fetch(url)
        .then(res => res.json())
        .then(json => appendPhonemeToMessage(parentLi, json))
        .catch(err => {
          console.error("Viseme JSON fetch failed:", err);
          appendPhonemeToMessage(parentLi, { error: "Failed to load viseme JSON." });
        });
    }

    function appendPhonemeToMessage(parentLi, phonemeJson) {
      const div = document.createElement("div");
      div.style.background = "#111";
      div.style.color = "#0ff";
      div.style.padding = "8px";
      div.style.borderRadius = "8px";
      div.style.marginTop = "6px";
      div.style.fontSize = "12px";
      div.style.whiteSpace = "pre-wrap";
      div.style.maxHeight = "200px";
      div.style.overflowY = "auto";

      try {
        const obj = typeof phonemeJson === "string" ? JSON.parse(phonemeJson) : phonemeJson;
        const cues = obj.mouthCues || [];
        if (cues.length === 0) {
          div.textContent = "No mouthCues found.";
        } else {
          const summary = cues.map(c => `[${c.start.toFixed(2)}s - ${c.end.toFixed(2)}s]: ${c.value}`).join("\n");
          div.textContent = "ðŸ‘„ LipSync Cues:\n" + summary;
        }
      } catch (err) {
        div.textContent = "Error parsing viseme data.";
        console.error("Phoneme parsing error:", err);
      }

      parentLi.appendChild(div);
    }

    function playAudio(audioBase64) {
      const audioPlayer = document.getElementById("audioPlayer");
      audioPlayer.src = "data:audio/mp3;base64," + audioBase64;
      audioPlayer.hidden = false;
      audioPlayer.play();
    }

    function playQueue() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        return;
      }
      isPlaying = true;
      const audioPlayer = document.getElementById("audioPlayer");
      const nextAudio = audioQueue.shift();
      audioPlayer.src = nextAudio;
      audioPlayer.hidden = false;
      audioPlayer.play();
      audioPlayer.onended = () => playQueue();
    }

    function startVoice() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-IN";
      recognition.start();
      recognition.onresult = (event) => {
        const speech = event.results[0][0].transcript;
        document.getElementById("messageInput").value = speech;
        sendMessage();
      };
      recognition.onerror = (event) => {
        console.error("ðŸŽ¤ Voice recognition error:", event.error);
      };
    }

    function formatBotMessage(text) {
      text = text.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${escapeHtml(code)}</code></pre>`);
      text = text.replace(/^\s*\*\s(.+)$/gm, "<li>$1</li>");
      text = text.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");
      return text.replace(/\n/g, "<br>");
    }

    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function scrollToBottom() {
      const chatBox = document.getElementById("chat-box");
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("mic-btn").onclick = startVoice;
  </script>
</body>
</html>

